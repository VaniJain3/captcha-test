<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>reCAPTCHA v3 Test</title>
  <script src="https://www.google.com/recaptcha/api.js?render=6LdTY_orAAAAAB7jGOIvrkK4YvJ3YHqo6ykyKWUy"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin-top: 60px; background: #f5f5f5; }
    h1 { color: #333; }
    button { padding: 10px 16px; border: none; background: #007bff; color: white; font-size: 15px; border-radius: 6px; cursor: pointer; }
    button:hover { background: #0056b3; }
    pre { background: #222; color: #0f0; padding: 10px; width: 80%; margin: 20px auto; border-radius: 6px; text-align: left; }
  </style>
</head>
<body>
  <h1>reCAPTCHA v3 Verification Test</h1>
  <button id="verify-btn">Run reCAPTCHA v3 and Verify</button>
  <button id="download-btn" style="display:none">⬇️ Download CSV</button>
  <pre id="output"></pre>

  <script>
    // In-memory results array for CSV (keeps session results)
    const results = [];
    const SITE_KEY = '6LdTY_orAAAAAB7jGOIvrkK4YvJ3YHqo6ykyKWUy';
    const VERIFY_URL = 'https://captcha-verifier-vanijain.vercel.app/api/verify';
    const verifyBtn = document.getElementById('verify-btn');
    const downloadBtn = document.getElementById('download-btn');
    const outputEl = document.getElementById('output');

    // Helper: build metrics object robustly from server response
    function buildMetrics(json, latencyMs) {
      // If server returns json.metrics prefer that (some server variants use it)
      const src = (json && json.metrics && typeof json.metrics === 'object') ? json.metrics : json || {};
      return {
        timestamp: new Date().toISOString(),
        provider: 'google-v3',
        success: (src.success === true) ? 'true' : String(src.success ?? 'false'),
        hostname: src.hostname || (json && json.hostname) || 'N/A',
        challenge_ts: src.challenge_ts || (json && json.challenge_ts) || 'N/A',
        score: (src.score !== undefined) ? src.score : (json && json.score !== undefined ? json.score : 'N/A'),
        action: src.action || (json && json.action) || 'N/A',
        latency_ms: (latencyMs != null) ? String(latencyMs) : ''
      };
    }

    // Main flow: get token, send to verifier, display and record
    async function runVerification() {
      outputEl.textContent = "⏳ Getting token...";
      try {
        await grecaptcha.ready();
      } catch (e) {
        outputEl.textContent = "Error: grecaptcha not ready: " + e;
        return;
      }

      let token;
      try {
        token = await grecaptcha.execute(SITE_KEY, { action: 'submit' });
      } catch (e) {
        outputEl.textContent = 'Error obtaining token: ' + e;
        return;
      }

      outputEl.textContent = "⏳ Sending token to verifier...";
      const start = performance.now();
      try {
        const resp = await fetch(VERIFY_URL, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ token, provider: 'google-v3' })
        });

        const json = await resp.json();
        const end = performance.now();
        const latency = (end - start).toFixed(2);

        // Preserve previous display behavior
        if (json && json.success) {
          outputEl.textContent = "✅ Verification Successful!\n\n" + JSON.stringify(json, null, 2);
        } else {
          outputEl.textContent = "❌ Verification Failed!\n\n" + JSON.stringify(json, null, 2);
        }

        // Build and store metrics row
        const row = buildMetrics(json, latency);
        results.push(row);

        // Show download button once we have at least one result
        if (results.length > 0) {
          downloadBtn.style.display = 'inline-block';
        }
      } catch (e) {
        outputEl.textContent = 'Verifier call failed: ' + e;
      }
    }

    verifyBtn.addEventListener('click', runVerification);

    // CSV download: stable header order
    downloadBtn.addEventListener('click', () => {
      if (results.length === 0) {
        alert('No metrics recorded yet.');
        return;
      }

      const headers = ['timestamp','provider','success','hostname','challenge_ts','score','action','latency_ms'];
      const lines = [headers.join(',')];

      for (const r of results) {
        const vals = headers.map(h => {
          const v = r[h];
          if (v === undefined || v === null) return '""';
          // Escape double quotes and wrap in quotes
          return `"${String(v).replace(/"/g, '""')}"`;
        });
        lines.push(vals.join(','));
      }

      const blob = new Blob([lines.join('\n')], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'recaptcha_v3_metrics.csv';
      a.click();
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>

